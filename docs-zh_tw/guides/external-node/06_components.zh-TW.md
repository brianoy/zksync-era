 <!-- 翻譯時間：2024/3/5 -->
# 外部節點的部件

本部分包含了外部節點的主要部件概述。

## API

外部節點可以提供 HTTP 和 WS Web3 API，以及 PubSub。它會從本地狀態提供數據，但有幾個例外：

- 提交交易：由於它是一個讀取副本，提交的交易將被代理到主節點，並且從主節點返回響應。
- 查詢交易：外部節點不知道主節點的內存池，也不會同步被拒絕的交易。因此，如果本地查找交易或其收據失敗，外部節點將嘗試在主節點上進行相同的查詢。

除了這些情況外，API 不依賴主節點。即使主節點暫時不可用，外部節點也可以繼續提供本地狀態。

## 抓取器

抓取器部件負責在外部節點和主節點之間維護同步。它的主要任務是抓取新區塊以更新本地鏈狀態。其職責不僅限於此，例如，抓取器還負責跟踪 L1 batch狀態。這涉及監控本地應用batch是否已提交、證明或在 L1 上執行。

除了抓取 _狀態_ 之外，外部節點還從主節點獲取 L1 的gas fee，以用於估算 L2 交易的費用（因為這也是基於本地狀態進行的）。為避免交易沒有被打包在區塊中，所以要確保與主節點以完全相同的方式估價gas fee。

## 狀態保持器 / VM

狀態保持器部件充當節點的“序列化器”部分。它與主節點的大部分功能相同，但有一個關鍵區別。主節點從內存池中獲取交易並有權決定何時封存特定的 L2 block 或 L1 batch。另一方面，外部節點從抓取器填充的隊列中檢索交易並根據從抓取器隊列獲取的數據封存相應的 block / batch。

批次的實際執行在 VM 中進行，該 VM 在主節點和外部節點中都是相同的。

## 重組檢測器

在 zkSync Era 中，理論上可以在寫入於 L1 之前（即區塊[最終確定][finality]之前）撤消 L1 batch，這在通常情況下是非常罕見的，通常是由於重大問題而發生，例如序列器實現中的錯誤阻止了 L1 batch的提交。在batch最終確定之前，zkSync 操作員可以撤銷一個或多個batch並將區塊鏈狀態還原到問題發生前的點，至於已最終確定的batch則無法被撤銷/還原。

即便這種情況很少見，外部節點也必須正確地處理它們。

為此，外部節點組合了一個重組檢測器部件。此模塊會監測尚未[最終確定][finality]的所有 L1 batch。它將從主節點 API 獲取的頂部雜湊值與主節點 API 提供的頂部雜湊值進行比較。如果最新可用的 L1 batch的頂部雜湊值不相符，則重組檢測器將負責尋找異常的 L1 batch。隨後，它將還原本地狀態並重新啟動節點。重新啟動後，外部節點應恢復正常操作。

[finality]: https://era.zksync.io/docs/dev/developer-guides/finality.html

## 一致性檢查器

主節點 API 作為外部節點的主要信息來源。但僅依賴 API 的安全性欠佳，因為 API 的數據會因為各種原因而異常。還原系統的主要來源是 L1 智能合約。因此，為了增強外部節點的安全性，每個 L1 batch都會通過稱為一致性檢查器的部件進行交叉檢查。

當一致性檢查器檢測到特定batch已發送到 L1 時，它將重新計算區塊承諾(Block Promise)的部分輸入，該區塊承諾包含重要數據(例如：狀態樹(state
root)和 batch 編號)，並且是用於 batch 驗證的相同承諾，然後一致性檢查器將本地獲得的承諾與發送到 L1 的實際承諾進行比較。
如果數據不匹配，則表示主節點或外部節點中可能存在錯誤，或者主節點 API 提供了不正確的數據，在這些情況下，外部節點的狀態都不能信任，並且外部節點進入崩潰循環，直到問題解決為止。

## 健康檢查服務器

外部節點擁有一個額外的公開伺服器，在外部節點正常運行時返回 HTTP 200 狀態碼，當某些健康檢查未通過時（例如當外部節點還沒有完全初始化時）返回 HTTP 503 狀態碼，你還可以使用此伺服器來探測解決方案中的就緒狀態。